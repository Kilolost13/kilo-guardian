name: Dry-run Deploy Validation

on:
  workflow_dispatch:
    inputs:
      skip_prometheus:
        description: 'Skip Helm Prometheus template check'
        required: false
        default: 'false'
      kubeconfig_base64:
        description: 'Optional base64 kubeconfig to use for server-side dry-run (leave blank to use local runner kubeconfig)'
        required: false
        default: ''

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Decode optional KUBECONFIG
        if: ${{ github.event.inputs.kubeconfig_base64 != '' }}
        run: |
          mkdir -p $HOME/.kube
          echo "${{ github.event.inputs.kubeconfig_base64 }}" | base64 --decode > $HOME/.kube/config

      - name: Show kubectl context
        run: |
          kubectl config view --minify || true
          kubectl version --short || true

      - name: Client-side dry-run (kubectl)
        run: |
          echo "Running kubectl client-side dry-run on k3s/ manifests"
          kubectl apply --recursive --dry-run=client -f k3s/

      - name: Render client-side manifests
        run: |
          echo "Rendering client-side manifests to /tmp/k3s-manifests/k3s-client-dryrun.yaml"
          mkdir -p /tmp/k3s-manifests
          kubectl apply --recursive --dry-run=client -f k3s/ -o yaml > /tmp/k3s-manifests/k3s-client-dryrun.yaml || true

      - name: Server-side dry-run (kubectl)
        run: |
          echo "Attempting server-side dry-run (may be unsupported on some clusters)"
          mkdir -p /tmp/k3s-manifests
          if kubectl apply --recursive --dry-run=server -f k3s/ -o yaml > /tmp/k3s-manifests/k3s-server-dryrun.yaml 2>/dev/null; then
            echo "server-side dry-run completed and saved to /tmp/k3s-manifests/k3s-server-dryrun.yaml"
          else
            echo "server-side dry-run failed or unsupported â€” continuing"
          fi
        continue-on-error: true

      - name: Helm chart template check (Prometheus)
        if: ${{ github.event.inputs.skip_prometheus != 'true' && github.event.inputs.skip_prometheus != '1' }}
        run: |
          echo "Checking Prometheus Helm chart templating"
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
          helm repo update || true
          helm template monitoring prometheus-community/kube-prometheus-stack -n monitoring -f k3s/prometheus-values.yaml --include-crds --skip-tests > /tmp/k3s-manifests/prometheus-render.yaml
          echo "Rendered Prometheus chart (first 200 lines):"
          head -n 200 /tmp/k3s-manifests/prometheus-render.yaml || true

      - name: Upload rendered manifests artifact
        uses: actions/upload-artifact@v4
        with:
          name: k3s-rendered-manifests-${{ github.run_number }}
          path: /tmp/k3s-manifests

      - name: Finish
        run: |
          echo "Dry-run validation finished successfully. If any step failed, review the logs above."
