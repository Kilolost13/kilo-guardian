name: Deploy to K3s

on:
  workflow_dispatch:
    inputs:
      skip_prometheus:
        description: 'Skip Helm Prometheus installation'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v1
        with:
          version: 'v3.12.3'

      - name: Decode KUBECONFIG from secret
        if: secrets.KUBECONFIG_BASE64 != ''
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_BASE64" | base64 --decode > $HOME/.kube/config
        env:
          KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}

      - name: Show cluster context
        run: kubectl config view --minify || true

      - name: Deploy k3s manifests
        run: |
          chmod +x ./k3s/deploy.sh
          KUBECONFIG=$HOME/.kube/config ./k3s/deploy.sh
        env:
          SKIP_PROMETHEUS: ${{ github.event.inputs.skip_prometheus }}

      - name: Print cluster objects (kilo-guardian)
        run: |
          kubectl -n kilo-guardian get deployments,services,pods -o wide || true

      - name: Notify deploy result (Slack/Discord webhooks optional)
        if: always()
        run: |
          set -e
          STATUS=$([ "$GITHUB_JOB" = "deploy" ] && echo "succeded" || echo "completed")

          # Slack notification (if SLACK_WEBHOOK secret provided)
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            payload="{\"text\": \"K3s deploy: ${{ github.repository }}#${{ github.run_number }} ${STATUS} by ${{ github.actor }} (<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|details>)\"}"
            curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "${{ secrets.SLACK_WEBHOOK }}" || true
          fi

          # Discord notification (if DISCORD_WEBHOOK secret provided)
          if [ -n "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            payload="{\"content\": \"K3s deploy: ${{ github.repository }}#${{ github.run_number }} ${STATUS} by ${{ github.actor }} - <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>\"}"
            curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "${{ secrets.DISCORD_WEBHOOK }}" || true
          fi
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
