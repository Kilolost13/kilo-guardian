name: CI Failure Reporter

# TODO: This workflow references a "CI" workflow that doesn't exist.
# Update workflow_run.workflows to match actual workflow names like:
# "Playwright E2E", "Docker Compose smoke test", "Validate Kubernetes manifests"

on:
  workflow_run:
    workflows: ["Playwright E2E"]
    types:
      - completed

jobs:
  report:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create issue on CI failure
        uses: actions/github-script@v6
        with:
          script: |
            const run = context.payload.workflow_run;
            const sha = run.head_sha;
            const url = run.html_url;
            const title = `CI failure: workflow run ${run.name} (${run.conclusion})`;
            const body = `CI workflow **${run.name}** failed for commit ${sha}.\n\nRun details: ${url}\n\nThis issue was created automatically for triage.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['ci-failure']
            });