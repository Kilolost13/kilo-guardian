name: Docker Compose smoke test

on:
  push:
    paths:
      - 'services/**'
      - 'infra/docker/**'
      - 'scripts/**'
  workflow_dispatch: {}

jobs:
  compose-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and start compose stack
        working-directory: ./infra/docker
        run: |
          docker-compose build --parallel
          docker-compose up -d --remove-orphans

      - name: Wait for services
        working-directory: ./infra/docker
        run: |
          for i in {1..30}; do
            echo "Waiting for ai_brain... ($i)"
            if docker-compose ps | grep ai_brain | grep healthy >/dev/null 2>&1; then
              echo "ai_brain healthy"
              break
            fi
            sleep 5
          done

      - name: Run smoke test script
        # Runs from repository root (default working directory)
        run: |
          chmod +x ./scripts/smoke_test.sh
          ./scripts/smoke_test.sh localhost 9004 8000

      - name: Tear down compose
        if: always()
        working-directory: ./infra/docker
        run: |
          docker-compose down --volumes --remove-orphans
      
      - name: Smoke Test Summary
        if: always()
        run: |
          echo "=== Smoke Test Summary ==="
          echo "Docker compose build: Check logs above"
          echo "Services health check: Check ai_brain status above"
          echo "Smoke test script: Check test results above"
